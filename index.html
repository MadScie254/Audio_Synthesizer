<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APEX Audio Synthesizer - Trap Nation Visualizer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --neon-pink: #FF006E;
            --neon-cyan: #00D9FF;
            --neon-purple: #B537F2;
            --neon-lime: #00FF41;
            --dark-bg: #0a0e27;
            --card-bg: rgba(20, 30, 60, 0.4);
            --accent: #667eea;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--dark-bg), #1a0033, #0d0820);
            color: white;
            overflow: hidden;
            position: relative;
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        #mainCanvas, #backgroundCanvas, #foregroundCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        #backgroundCanvas {
            z-index: 1;
            filter: blur(1px);
        }

        #mainCanvas {
            z-index: 2;
        }

        #foregroundCanvas {
            z-index: 3;
            pointer-events: none;
        }

        .glow-border {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 20px;
            padding: 2px;
            background: linear-gradient(135deg, var(--neon-cyan), var(--neon-pink), var(--neon-purple));
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: exclude;
            -webkit-mask-composite: xor;
            pointer-events: none;
            opacity: 0.6;
        }

        .control-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 255, 255, 0.2);
            border-radius: 20px;
            padding: 25px;
            width: 340px;
            max-height: 90vh;
            overflow-y: auto;
            z-index: 100;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 40px rgba(102, 126, 234, 0.15), inset 0 0 40px rgba(102, 126, 234, 0.05);
        }

        .control-panel:hover {
            border-color: rgba(0, 255, 255, 0.5);
            box-shadow: 0 0 60px rgba(102, 126, 234, 0.25), inset 0 0 40px rgba(102, 126, 234, 0.1);
        }

        .control-panel.collapsed {
            transform: translateX(360px);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(0, 217, 255, 0.3);
            gap: 10px;
        }

        .panel-title {
            font-size: 1.3rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--neon-cyan), var(--neon-pink));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            background: linear-gradient(135deg, var(--neon-lime), var(--neon-cyan));
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 700;
            color: #000;
            text-transform: uppercase;
            letter-spacing: 1px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .toggle-panel {
            position: absolute;
            left: -50px;
            top: 20px;
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, var(--neon-purple), var(--neon-pink));
            border: 2px solid var(--neon-cyan);
            border-radius: 12px 0 0 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.2rem;
            box-shadow: 0 0 20px rgba(0, 217, 255, 0.3);
        }

        .toggle-panel:hover {
            left: -50px;
            box-shadow: 0 0 40px rgba(255, 0, 110, 0.5);
            transform: scale(1.05);
        }

        .control-section {
            margin-bottom: 28px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(0, 217, 255, 0.15);
        }

        .control-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .section-title {
            font-size: 0.8rem;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--neon-cyan);
            text-transform: uppercase;
            letter-spacing: 2px;
            opacity: 0.9;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            display: block;
            padding: 14px;
            background: linear-gradient(135deg, var(--neon-pink), var(--neon-purple));
            color: white;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
            font-weight: 600;
            border: 2px solid rgba(255, 0, 110, 0.3);
            box-shadow: 0 0 20px rgba(255, 0, 110, 0.2);
            text-transform: uppercase;
            font-size: 0.9rem;
            letter-spacing: 1px;
        }

        .file-input-label:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(255, 0, 110, 0.4);
            border-color: rgba(255, 0, 110, 0.6);
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 18px;
        }

        button {
            padding: 12px;
            background: linear-gradient(135deg, rgba(0, 217, 255, 0.15), rgba(181, 55, 242, 0.15));
            color: white;
            border: 2px solid rgba(0, 217, 255, 0.3);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 0 15px rgba(0, 217, 255, 0.1);
        }

        button:hover {
            background: linear-gradient(135deg, rgba(0, 217, 255, 0.25), rgba(181, 55, 242, 0.25));
            transform: translateY(-2px);
            border-color: rgba(0, 217, 255, 0.6);
            box-shadow: 0 5px 25px rgba(0, 217, 255, 0.3);
        }

        button.active {
            background: linear-gradient(135deg, var(--neon-cyan), var(--neon-purple));
            border-color: var(--neon-cyan);
            color: #000;
            box-shadow: 0 0 30px rgba(0, 217, 255, 0.5);
            font-weight: 700;
        }

        .slider-control {
            margin-bottom: 18px;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.8rem;
            color: rgba(0, 217, 255, 0.9);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            background: linear-gradient(to right, var(--neon-cyan), var(--neon-purple), var(--neon-pink));
            border-radius: 3px;
            outline: none;
            appearance: none;
            -webkit-appearance: none;
            position: relative;
        }

        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: linear-gradient(135deg, var(--neon-cyan), var(--neon-pink));
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(0, 217, 255, 0.6);
            border: 2px solid rgba(255, 255, 255, 0.3);
            transition: all 0.2s ease;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 25px rgba(0, 217, 255, 0.8);
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: linear-gradient(135deg, var(--neon-cyan), var(--neon-pink));
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 15px rgba(0, 217, 255, 0.6);
            transition: all 0.2s ease;
        }

        input[type="range"]::-moz-range-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 25px rgba(0, 217, 255, 0.8);
        }

        .mode-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .mode-btn {
            padding: 11px;
            font-size: 0.8rem;
            background: linear-gradient(135deg, rgba(0, 217, 255, 0.1), rgba(181, 55, 242, 0.1));
            border: 2px solid rgba(0, 217, 255, 0.2);
            color: rgba(0, 217, 255, 0.9);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .mode-btn.active {
            background: linear-gradient(135deg, var(--neon-cyan), var(--neon-purple));
            border-color: var(--neon-cyan);
            color: #000;
            box-shadow: 0 0 20px rgba(0, 217, 255, 0.5);
        }

        .synth-keys {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 6px;
            margin-top: 12px;
            padding: 15px;
            background: linear-gradient(135deg, rgba(0, 217, 255, 0.05), rgba(181, 55, 242, 0.05));
            border-radius: 12px;
            border: 1px solid rgba(0, 217, 255, 0.2);
        }

        .synth-key {
            aspect-ratio: 1;
            background: linear-gradient(135deg, rgba(0, 217, 255, 0.15), rgba(181, 55, 242, 0.15));
            border: 2px solid rgba(0, 217, 255, 0.3);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--neon-cyan);
            box-shadow: 0 0 10px rgba(0, 217, 255, 0.1);
        }

        .synth-key:hover {
            background: linear-gradient(135deg, rgba(0, 217, 255, 0.3), rgba(181, 55, 242, 0.3));
            border-color: var(--neon-cyan);
            box-shadow: 0 0 20px rgba(0, 217, 255, 0.3);
            transform: translateY(-2px);
        }

        .synth-key.active {
            background: linear-gradient(135deg, var(--neon-cyan), var(--neon-purple));
            border-color: var(--neon-cyan);
            color: #000;
            transform: scale(0.92);
            box-shadow: 0 0 30px rgba(0, 217, 255, 0.6);
        }

        select {
            width: 100%;
            padding: 11px;
            background: linear-gradient(135deg, rgba(0, 217, 255, 0.15), rgba(181, 55, 242, 0.15));
            color: var(--neon-cyan);
            border: 2px solid rgba(0, 217, 255, 0.3);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        select:hover {
            border-color: var(--neon-cyan);
            box-shadow: 0 0 15px rgba(0, 217, 255, 0.3);
            background: linear-gradient(135deg, rgba(0, 217, 255, 0.25), rgba(181, 55, 242, 0.25));
        }

        select option {
            background: var(--dark-bg);
            color: var(--neon-cyan);
            font-weight: 600;
        }

        .info-panel {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: var(--card-bg);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(0, 217, 255, 0.3);
            z-index: 100;
            min-width: 280px;
            box-shadow: 0 0 40px rgba(102, 126, 234, 0.15), inset 0 0 40px rgba(102, 126, 234, 0.05);
            transition: all 0.3s ease;
        }

        .info-panel:hover {
            border-color: rgba(0, 217, 255, 0.6);
            box-shadow: 0 0 60px rgba(102, 126, 234, 0.25), inset 0 0 40px rgba(102, 126, 234, 0.1);
        }

        .spectrum-title {
            font-size: 0.9rem;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--neon-cyan);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .frequency-bars {
            display: flex;
            gap: 3px;
            height: 40px;
            margin-top: 12px;
            align-items: flex-end;
        }

        .freq-bar {
            flex: 1;
            background: linear-gradient(to top, var(--neon-cyan), var(--neon-pink));
            border-radius: 2px 2px 0 0;
            transition: height 0.1s ease;
            box-shadow: 0 0 10px rgba(0, 217, 255, 0.4);
        }

        .info-stats {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(0, 217, 255, 0.2);
            font-size: 0.8rem;
            color: rgba(0, 217, 255, 0.8);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, rgba(0, 0, 0, 0.95), #0a0e27);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.5s ease;
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-text {
            font-size: 1.8rem;
            margin-bottom: 30px;
            background: linear-gradient(135deg, var(--neon-cyan), var(--neon-pink));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .loading-spinner {
            width: 80px;
            height: 80px;
            border: 4px solid rgba(0, 217, 255, 0.1);
            border-top: 4px solid var(--neon-cyan);
            border-right: 4px solid var(--neon-purple);
            border-radius: 50%;
            animation: spin 1.5s linear infinite;
            box-shadow: 0 0 40px rgba(0, 217, 255, 0.5);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .tooltip {
            position: absolute;
            background: linear-gradient(135deg, var(--neon-pink), var(--neon-purple));
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.8rem;
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 0 20px rgba(255, 0, 110, 0.4);
        }

        .tooltip.visible {
            opacity: 1;
        }

        /* PREMIUM ANIMATIONS */
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }

        @keyframes glow-pulse {
            0%, 100% { box-shadow: 0 0 20px rgba(0, 217, 255, 0.5); }
            50% { box-shadow: 0 0 40px rgba(0, 217, 255, 0.8), 0 0 60px rgba(255, 0, 110, 0.4); }
        }

        @keyframes title-glow {
            0%, 100% { text-shadow: 0 0 10px var(--neon-cyan); }
            50% { text-shadow: 0 0 20px var(--neon-cyan), 0 0 30px var(--neon-purple); }
        }

        /* Scrollbar styling */
        .control-panel::-webkit-scrollbar {
            width: 8px;
        }

        .control-panel::-webkit-scrollbar-track {
            background: rgba(0, 217, 255, 0.1);
            border-radius: 10px;
        }

        .control-panel::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--neon-cyan), var(--neon-purple));
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 217, 255, 0.5);
        }

        .control-panel::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, var(--neon-pink), var(--neon-cyan));
        }

        @media (max-width: 768px) {
            .control-panel {
                width: 300px;
                right: 10px;
                top: 10px;
                padding: 20px;
            }

            .info-panel {
                bottom: 10px;
                left: 10px;
                min-width: 250px;
                padding: 15px;
            }

            .panel-title {
                font-size: 1.1rem;
            }
        }
    </style>
</head>
<body>
    <canvas id="backgroundCanvas"></canvas>
    <canvas id="mainCanvas"></canvas>
    <canvas id="foregroundCanvas"></canvas>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-text">üéõÔ∏è APEX SYNTHESIZER</div>
        <div class="loading-spinner"></div>
    </div>

    <div class="control-panel" id="controlPanel">
        <div class="toggle-panel" id="togglePanel">
            <span>‚ò∞</span>
        </div>
        
        <div class="panel-header">
            <div class="panel-title">‚ö° APEX</div>
            <div class="status-badge">LIVE</div>
        </div>

        <div class="control-section">
            <div class="section-title">üéµ Audio Source</div>
            <div class="file-input-wrapper">
                <input type="file" id="audioFile" accept="audio/*" title="Load Audio File">
                <label for="audioFile" class="file-input-label">
                    üìÅ Load Audio
                </label>
            </div>
            <div class="button-group">
                <button id="micBtn" title="Toggle Microphone">üé§ MIC</button>
                <button id="playBtn" title="Play Audio">‚ñ∂Ô∏è PLAY</button>
            </div>
        </div>

        <div class="control-section">
            <div class="section-title">üëÅÔ∏è Visualization</div>
            <div class="mode-grid">
                <button class="mode-btn active" data-mode="hypnotic" title="Hypnotic mode">Hypnotic</button>
                <button class="mode-btn" data-mode="fractal" title="Fractal mode">Fractal</button>
                <button class="mode-btn" data-mode="vocal" title="Vocal mode">Vocal</button>
                <button class="mode-btn" data-mode="synth" title="Synth mode">Synth</button>
                <button class="mode-btn" data-mode="quantum" title="Quantum mode">Quantum</button>
                <button class="mode-btn" data-mode="neural" title="Neural mode">Neural</button>
            </div>
        </div>

        <div class="control-section">
            <div class="section-title">üéöÔ∏è Effects</div>
            <div class="slider-control">
                <div class="slider-label">
                    <span>Reverb</span>
                    <span id="reverbValue">50%</span>
                </div>
                <input type="range" id="reverbSlider" min="0" max="100" value="50" title="Reverb Amount">
            </div>
            <div class="slider-control">
                <div class="slider-label">
                    <span>Distortion</span>
                    <span id="distortionValue">0%</span>
                </div>
                <input type="range" id="distortionSlider" min="0" max="100" value="0" title="Distortion Amount">
            </div>
            <div class="slider-control">
                <div class="slider-label">
                    <span>Delay</span>
                    <span id="delayValue">30%</span>
                </div>
                <input type="range" id="delaySlider" min="0" max="100" value="30" title="Delay Amount">
            </div>
        </div>

        <div class="control-section">
            <div class="section-title">üéπ Synthesizer</div>
            <div class="synth-keys" id="synthKeys">
                <div class="synth-key" data-note="C" title="C Note">C</div>
                <div class="synth-key" data-note="D" title="D Note">D</div>
                <div class="synth-key" data-note="E" title="E Note">E</div>
                <div class="synth-key" data-note="F" title="F Note">F</div>
                <div class="synth-key" data-note="G" title="G Note">G</div>
                <div class="synth-key" data-note="A" title="A Note">A</div>
                <div class="synth-key" data-note="B" title="B Note">B</div>
                <div class="synth-key" data-note="C2" title="High C">C+</div>
            </div>
            <div class="slider-control">
                <div class="slider-label">
                    <span>Wave Type</span>
                </div>
                <select id="waveType" title="Select waveform type">
                    <option value="sine">Sine</option>
                    <option value="square">Square</option>
                    <option value="sawtooth">Sawtooth</option>
                    <option value="triangle">Triangle</option>
                </select>
            </div>
        </div>

        <div class="control-section">
            <div class="section-title">üé® Visual Settings</div>
            <div class="slider-control">
                <div class="slider-label">
                    <span>Intensity</span>
                    <span id="intensityValue">70%</span>
                </div>
                <input type="range" id="intensitySlider" min="0" max="100" value="70" title="Visual Intensity">
            </div>
            <div class="slider-control">
                <div class="slider-label">
                    <span>Particles</span>
                    <span id="particlesValue">50</span>
                </div>
                <input type="range" id="particlesSlider" min="0" max="200" value="50" title="Particle Count">
            </div>
        </div>
    </div>

    <div class="info-panel">
        <div class="spectrum-title">üîä Frequency Spectrum</div>
        <div class="frequency-bars" id="frequencyBars">
            <div class="freq-bar"></div>
            <div class="freq-bar"></div>
            <div class="freq-bar"></div>
            <div class="freq-bar"></div>
            <div class="freq-bar"></div>
            <div class="freq-bar"></div>
            <div class="freq-bar"></div>
            <div class="freq-bar"></div>
        </div>
        <div class="info-stats">
            <span id="modeIndicator">MODE: HYPNOTIC</span> | 
            <span id="fpsIndicator">60 FPS</span>
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
        class ImmersiveAudioVisualizer {
            constructor() {
                this.bgCanvas = document.getElementById('backgroundCanvas');
                this.mainCanvas = document.getElementById('mainCanvas');
                this.fgCanvas = document.getElementById('foregroundCanvas');
                
                this.bgCtx = this.bgCanvas.getContext('2d');
                this.mainCtx = this.mainCanvas.getContext('2d');
                this.fgCtx = this.fgCanvas.getContext('2d');
                
                this.audioContext = null;
                this.analyser = null;
                this.source = null;
                this.audio = new Audio();
                this.microphone = null;
                this.isPlaying = false;
                this.isMicrophoneActive = false;
                
                this.mode = 'hypnotic';
                this.particles = [];
                this.waves = [];
                this.neurons = [];
                this.fractals = [];
                
                this.mouseX = 0;
                this.mouseY = 0;
                this.targetMouseX = 0;
                this.targetMouseY = 0;
                
                this.settings = {
                    intensity: 0.7,
                    particleCount: 50,
                    reverb: 0.5,
                    distortion: 0,
                    delay: 0.3,
                    waveType: 'sine'
                };
                
                this.fps = 60;
                this.frameCount = 0;
                this.lastTime = performance.now();
                
                this.synthOscillators = {};
                this.gainNodes = {};
                
                this.init();
            }
            
            async init() {
                this.setupCanvas();
                this.setupAudio();
                this.setupEventListeners();
                this.initializeVisualElements();
                
                // Hide loading overlay
                setTimeout(() => {
                    document.getElementById('loadingOverlay').classList.add('hidden');
                }, 1000);
                
                this.animate();
            }
            
            setupCanvas() {
                const resize = () => {
                    this.bgCanvas.width = window.innerWidth;
                    this.bgCanvas.height = window.innerHeight;
                    this.mainCanvas.width = window.innerWidth;
                    this.mainCanvas.height = window.innerHeight;
                    this.fgCanvas.width = window.innerWidth;
                    this.fgCanvas.height = window.innerHeight;
                };
                
                resize();
                window.addEventListener('resize', resize);
            }
            
            setupAudio() {
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                this.analyser = this.audioContext.createAnalyser();
                this.analyser.fftSize = 2048;
                this.analyser.smoothingTimeConstant = 0.8;
                
                this.bufferLength = this.analyser.frequencyBinCount;
                this.dataArray = new Uint8Array(this.bufferLength);
                this.frequencyData = new Uint8Array(this.bufferLength);
                
                // Create effects nodes
                this.createEffects();
            }
            
            createEffects() {
                // Create reverb
                this.convolver = this.audioContext.createConvolver();
                this.reverbGain = this.audioContext.createGain();
                this.reverbGain.gain.value = this.settings.reverb;
                
                // Create distortion
                this.distortion = this.audioContext.createWaveShaper();
                this.distortion.curve = this.makeDistortionCurve(this.settings.distortion);
                this.distortion.oversample = '4x';
                
                // Create delay
                this.delay = this.audioContext.createDelay(1.0);
                this.delay.delayTime.value = this.settings.delay;
                this.feedback = this.audioContext.createGain();
                this.feedback.gain.value = 0.5;
                
                // Connect effects
                this.delay.connect(this.feedback);
                this.feedback.connect(this.delay);
            }
            
            makeDistortionCurve(amount) {
                const samples = 44100;
                const curve = new Float32Array(samples);
                const deg = Math.PI / 180;
                
                for (let i = 0; i < samples; i++) {
                    const x = (i * 2) / samples - 1;
                    curve[i] = ((3 + amount) * x * 20 * deg) / (Math.PI + amount * Math.abs(x));
                }
                
                return curve;
            }
            
            setupEventListeners() {
                // File input
                document.getElementById('audioFile').addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        this.loadAudioFile(file);
                    }
                });
                
                // Play button
                document.getElementById('playBtn').addEventListener('click', () => {
                    this.togglePlayback();
                });
                
                // Microphone button
                document.getElementById('micBtn').addEventListener('click', () => {
                    this.toggleMicrophone();
                });
                
                // Mode buttons
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        this.mode = e.target.dataset.mode;
                        document.getElementById('modeIndicator').textContent = `Mode: ${this.mode.charAt(0).toUpperCase() + this.mode.slice(1)}`;
                        this.initializeMode();
                    });
                });
                
                // Sliders
                document.getElementById('reverbSlider').addEventListener('input', (e) => {
                    this.settings.reverb = e.target.value / 100;
                    document.getElementById('reverbValue').textContent = `${e.target.value}%`;
                    if (this.reverbGain) this.reverbGain.gain.value = this.settings.reverb;
                });
                
                document.getElementById('distortionSlider').addEventListener('input', (e) => {
                    this.settings.distortion = e.target.value / 100;
                    document.getElementById('distortionValue').textContent = `${e.target.value}%`;
                    if (this.distortion) this.distortion.curve = this.makeDistortionCurve(this.settings.distortion * 100);
                });
                
                document.getElementById('delaySlider').addEventListener('input', (e) => {
                    this.settings.delay = e.target.value / 100;
                    document.getElementById('delayValue').textContent = `${e.target.value}%`;
                    if (this.delay) this.delay.delayTime.value = this.settings.delay;
                });
                
                document.getElementById('intensitySlider').addEventListener('input', (e) => {
                    this.settings.intensity = e.target.value / 100;
                    document.getElementById('intensityValue').textContent = `${e.target.value}%`;
                });
                
                document.getElementById('particlesSlider').addEventListener('input', (e) => {
                    this.settings.particleCount = parseInt(e.target.value);
                    document.getElementById('particlesValue').textContent = e.target.value;
                    this.initializeParticles();
                });
                
                document.getElementById('waveType').addEventListener('change', (e) => {
                    this.settings.waveType = e.target.value;
                });
                
                // Synthesizer keys
                document.querySelectorAll('.synth-key').forEach(key => {
                    key.addEventListener('mousedown', (e) => {
                        this.playSynthNote(e.target.dataset.note);
                        e.target.classList.add('active');
                    });
                    
                    key.addEventListener('mouseup', (e) => {
                        this.stopSynthNote(e.target.dataset.note);
                        e.target.classList.remove('active');
                    });
                    
                    key.addEventListener('mouseleave', (e) => {
                        this.stopSynthNote(e.target.dataset.note);
                        e.target.classList.remove('active');
                    });
                });
                
                // Mouse tracking
                window.addEventListener('mousemove', (e) => {
                    this.targetMouseX = e.clientX;
                    this.targetMouseY = e.clientY;
                });
                
                // Touch tracking
                window.addEventListener('touchmove', (e) => {
                    if (e.touches.length > 0) {
                        this.targetMouseX = e.touches[0].clientX;
                        this.targetMouseY = e.touches[0].clientY;
                    }
                });
                
                // Panel toggle
                document.getElementById('togglePanel').addEventListener('click', () => {
                    document.getElementById('controlPanel').classList.toggle('collapsed');
                });
            }
            
            initializeVisualElements() {
                this.initializeParticles();
                this.initializeWaves();
                this.initializeNeurons();
                this.initializeFractals();
            }
            
            initializeParticles() {
                this.particles = [];
                for (let i = 0; i < this.settings.particleCount; i++) {
                    this.particles.push({
                        x: Math.random() * this.mainCanvas.width,
                        y: Math.random() * this.mainCanvas.height,
                        vx: (Math.random() - 0.5) * 2,
                        vy: (Math.random() - 0.5) * 2,
                        size: Math.random() * 3 + 1,
                        color: `hsl(${Math.random() * 360}, 70%, 50%)`,
                        life: 1,
                        maxLife: Math.random() * 100 + 100,
                        frequency: Math.random() * this.bufferLength
                    });
                }
            }
            
            initializeWaves() {
                this.waves = [];
                for (let i = 0; i < 5; i++) {
                    this.waves.push({
                        amplitude: Math.random() * 50 + 20,
                        frequency: Math.random() * 0.02 + 0.01,
                        phase: Math.random() * Math.PI * 2,
                        speed: Math.random() * 0.05 + 0.01,
                        color: `hsl(${200 + i * 20}, 70%, 50%)`
                    });
                }
            }
            
            initializeNeurons() {
                this.neurons = [];
                const gridSize = 10;
                const spacing = Math.min(this.mainCanvas.width, this.mainCanvas.height) / gridSize;
                
                for (let i = 0; i < gridSize; i++) {
                    for (let j = 0; j < gridSize; j++) {
                        this.neurons.push({
                            x: (i + 0.5) * spacing,
                            y: (j + 0.5) * spacing,
                            activation: 0,
                            targetActivation: 0,
                            connections: []
                        });
                    }
                }
                
                // Create connections
                this.neurons.forEach((neuron, i) => {
                    this.neurons.forEach((other, j) => {
                        if (i !== j && Math.random() > 0.7) {
                            const distance = Math.sqrt(
                                Math.pow(neuron.x - other.x, 2) + 
                                Math.pow(neuron.y - other.y, 2)
                            );
                            if (distance < spacing * 2) {
                                neuron.connections.push(j);
                            }
                        }
                    });
                });
            }
            
            initializeFractals() {
                this.fractals = [];
                const centerX = this.mainCanvas.width / 2;
                const centerY = this.mainCanvas.height / 2;
                
                for (let i = 0; i < 6; i++) {
                    const angle = (i / 6) * Math.PI * 2;
                    this.fractals.push({
                        x: centerX,
                        y: centerY,
                        angle: angle,
                        radius: 100,
                        depth: 4,
                        branches: 3,
                        growth: 0,
                        maxGrowth: 1,
                        color: `hsl(${i * 60}, 70%, 50%)`
                    });
                }
            }
            
            initializeMode() {
                switch(this.mode) {
                    case 'hypnotic':
                        this.initializeWaves();
                        break;
                    case 'fractal':
                        this.initializeFractals();
                        break;
                    case 'neural':
                        this.initializeNeurons();
                        break;
                    case 'vocal':
                        this.initializeVocalDetection();
                        break;
                }
            }
            
            initializeVocalDetection() {
                // Initialize vocal frequency bands
                this.vocalBands = {
                    bass: { min: 0, max: 10 },
                    lowMid: { min: 10, max: 30 },
                    mid: { min: 30, max: 60 },
                    highMid: { min: 60, max: 120 },
                    vocal: { min: 120, max: 256 },
                    treble: { min: 256, max: 512 }
                };
            }
            
            async loadAudioFile(file) {
                const url = URL.createObjectURL(file);
                this.audio.src = url;
                
                if (this.source) {
                    this.source.disconnect();
                }
                
                this.source = this.audioContext.createMediaElementSource(this.audio);
                this.connectAudioNodes();
                
                this.audio.addEventListener('loadedmetadata', () => {
                    document.getElementById('playBtn').disabled = false;
                });
            }
            
            connectAudioNodes() {
                // Connect audio through effects chain
                this.source.connect(this.analyser);
                this.source.connect(this.distortion);
                this.distortion.connect(this.delay);
                this.delay.connect(this.reverbGain);
                this.reverbGain.connect(this.audioContext.destination);
                this.delay.connect(this.audioContext.destination);
            }
            
            togglePlayback() {
                if (this.isPlaying) {
                    this.audio.pause();
                    document.getElementById('playBtn').textContent = '‚ñ∂Ô∏è Play';
                } else {
                    this.audio.play();
                    document.getElementById('playBtn').textContent = '‚è∏Ô∏è Pause';
                }
                this.isPlaying = !this.isPlaying;
            }
            
            async toggleMicrophone() {
                if (this.isMicrophoneActive) {
                    if (this.microphone) {
                        this.microphone.disconnect();
                    }
                    this.isMicrophoneActive = false;
                    document.getElementById('micBtn').classList.remove('active');
                } else {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        this.microphone = this.audioContext.createMediaStreamSource(stream);
                        this.microphone.connect(this.analyser);
                        this.isMicrophoneActive = true;
                        document.getElementById('micBtn').classList.add('active');
                    } catch (err) {
                        console.error('Error accessing microphone:', err);
                    }
                }
            }
            
            playSynthNote(note) {
                if (this.synthOscillators[note]) return;
                
                const frequencies = {
                    'C': 261.63,
                    'D': 293.66,
                    'E': 329.63,
                    'F': 349.23,
                    'G': 392.00,
                    'A': 440.00,
                    'B': 493.88,
                    'C2': 523.25
                };
                
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.type = this.settings.waveType;
                oscillator.frequency.value = frequencies[note];
                
                gainNode.gain.setValueAtTime(0, this.audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.3, this.audioContext.currentTime + 0.01);
                
                oscillator.connect(gainNode);
                gainNode.connect(this.analyser);
                gainNode.connect(this.audioContext.destination);
                
                oscillator.start();
                
                this.synthOscillators[note] = oscillator;
                this.gainNodes[note] = gainNode;
            }
            
            stopSynthNote(note) {
                if (this.gainNodes[note]) {
                    this.gainNodes[note].gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + 0.1);
                    setTimeout(() => {
                        if (this.synthOscillators[note]) {
                            this.synthOscillators[note].stop();
                            delete this.synthOscillators[note];
                            delete this.gainNodes[note];
                        }
                    }, 100);
                }
            }
            
            animate() {
                requestAnimationFrame(() => this.animate());
                
                // Update FPS
                this.frameCount++;
                const currentTime = performance.now();
                if (currentTime - this.lastTime >= 1000) {
                    this.fps = this.frameCount;
                    this.frameCount = 0;
                    this.lastTime = currentTime;
                    document.getElementById('fpsIndicator').textContent = `${this.fps} FPS`;
                }
                
                // Get audio data
                if (this.analyser) {
                    this.analyser.getByteFrequencyData(this.frequencyData);
                    this.analyser.getByteTimeDomainData(this.dataArray);
                }
                
                // Update mouse position with smoothing
                this.mouseX += (this.targetMouseX - this.mouseX) * 0.1;
                this.mouseY += (this.targetMouseY - this.mouseY) * 0.1;
                
                // Clear canvases
                this.bgCtx.fillStyle = 'rgba(0, 0, 0, 0.05)';
                this.bgCtx.fillRect(0, 0, this.bgCanvas.width, this.bgCanvas.height);
                
                this.mainCtx.clearRect(0, 0, this.mainCanvas.width, this.mainCanvas.height);
                this.fgCtx.clearRect(0, 0, this.fgCanvas.width, this.fgCanvas.height);
                
                // Draw based on mode
                switch(this.mode) {
                    case 'hypnotic':
                        this.drawHypnotic();
                        break;
                    case 'fractal':
                        this.drawFractal();
                        break;
                    case 'vocal':
                        this.drawVocal();
                        break;
                    case 'synth':
                        this.drawSynthesizer();
                        break;
                    case 'quantum':
                        this.drawQuantum();
                        break;
                    case 'neural':
                        this.drawNeural();
                        break;
                }
                
                // Update frequency bars
                this.updateFrequencyBars();
            }
            
            drawHypnotic() {
                const centerX = this.mainCanvas.width / 2;
                const centerY = this.mainCanvas.height / 2;
                const time = Date.now() * 0.001;
                
                // Draw hypnotic spiral waves
                this.waves.forEach((wave, index) => {
                    this.mainCtx.beginPath();
                    this.mainCtx.strokeStyle = wave.color;
                    this.mainCtx.lineWidth = 2;
                    this.mainCtx.globalAlpha = 0.7;
                    
                    for (let angle = 0; angle < Math.PI * 20; angle += 0.1) {
                        const radius = angle * 10 + wave.amplitude * Math.sin(angle * wave.frequency + time * wave.speed);
                        const x = centerX + Math.cos(angle + wave.phase) * radius;
                        const y = centerY + Math.sin(angle + wave.phase) * radius;
                        
                        if (angle === 0) {
                            this.mainCtx.moveTo(x, y);
                        } else {
                            this.mainCtx.lineTo(x, y);
                        }
                    }
                    
                    this.mainCtx.stroke();
                });
                
                // Draw reactive particles
                this.drawParticles();
                
                // Draw center pulse
                const average = this.frequencyData ? 
                    this.frequencyData.reduce((a, b) => a + b) / this.frequencyData.length : 0;
                const pulseRadius = 50 + average * 0.5;
                
                const gradient = this.mainCtx.createRadialGradient(centerX, centerY, 0, centerX, centerY, pulseRadius);
                gradient.addColorStop(0, 'rgba(102, 126, 234, 0.8)');
                gradient.addColorStop(0.5, 'rgba(118, 75, 162, 0.5)');
                gradient.addColorStop(1, 'rgba(102, 126, 234, 0)');
                
                this.mainCtx.fillStyle = gradient;
                this.mainCtx.beginPath();
                this.mainCtx.arc(centerX, centerY, pulseRadius, 0, Math.PI * 2);
                this.mainCtx.fill();
            }
            
            drawFractal() {
                const centerX = this.mainCanvas.width / 2;
                const centerY = this.mainCanvas.height / 2;
                const time = Date.now() * 0.0005;
                
                this.fractals.forEach((fractal, index) => {
                    fractal.growth = Math.min(fractal.growth + 0.01, fractal.maxGrowth);
                    
                    const audioInfluence = this.frequencyData ? 
                        this.frequencyData[index * 100] / 255 : 0;
                    
                    this.drawFractalBranch(
                        centerX, centerY,
                        fractal.angle + time,
                        fractal.radius * (1 + audioInfluence),
                        fractal.depth,
                        fractal.branches,
                        fractal.color,
                        fractal.growth
                    );
                });
                
                this.drawParticles();
            }
            
            drawFractalBranch(x, y, angle, length, depth, branches, color, growth) {
                if (depth <= 0 || growth <= 0) return;
                
                const endX = x + Math.cos(angle) * length * growth;
                const endY = y + Math.sin(angle) * length * growth;
                
                this.mainCtx.beginPath();
                this.mainCtx.moveTo(x, y);
                this.mainCtx.lineTo(endX, endY);
                this.mainCtx.strokeStyle = color;
                this.mainCtx.lineWidth = depth * 0.5;
                this.mainCtx.globalAlpha = growth;
                this.mainCtx.stroke();
                
                for (let i = 0; i < branches; i++) {
                    const branchAngle = angle + (i - branches / 2) * 0.5;
                    this.drawFractalBranch(
                        endX, endY,
                        branchAngle,
                        length * 0.7,
                        depth - 1,
                        branches,
                        color,
                        growth * 0.9
                    );
                }
            }
            
            drawVocal() {
                if (!this.frequencyData) return;
                
                const width = this.mainCanvas.width;
                const height = this.mainCanvas.height;
                const centerY = height / 2;
                
                // Draw vocal frequency bands
                const bandWidth = width / 6;
                const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD'];
                
                Object.entries(this.vocalBands).forEach(([bandName, range], index) => {
                    let sum = 0;
                    for (let i = range.min; i < range.max && i < this.frequencyData.length; i++) {
                        sum += this.frequencyData[i];
                    }
                    const average = sum / (range.max - range.min);
                    const barHeight = (average / 255) * height * 0.8;
                    
                    // Draw frequency bar
                    const gradient = this.mainCtx.createLinearGradient(0, centerY, 0, centerY - barHeight);
                    gradient.addColorStop(0, colors[index]);
                    gradient.addColorStop(1, 'transparent');
                    
                    this.mainCtx.fillStyle = gradient;
                    this.mainCtx.fillRect(
                        index * bandWidth,
                        centerY - barHeight,
                        bandWidth - 10,
                        barHeight
                    );
                    
                    // Draw reflection
                    this.mainCtx.fillStyle = `${colors[index]}33`;
                    this.mainCtx.fillRect(
                        index * bandWidth,
                        centerY,
                        bandWidth - 10,
                        barHeight * 0.3
                    );
                    
                    // Draw vocal waveform
                    if (bandName === 'vocal') {
                        this.mainCtx.beginPath();
                        this.mainCtx.strokeStyle = colors[index];
                        this.mainCtx.lineWidth = 2;
                        
                        for (let i = 0; i < this.bufferLength; i++) {
                            const x = (i / this.bufferLength) * width;
                            const y = centerY + (this.dataArray[i] - 128) * 2;
                            
                            if (i === 0) {
                                this.mainCtx.moveTo(x, y);
                            } else {
                                this.mainCtx.lineTo(x, y);
                            }
                        }
                        
                        this.mainCtx.stroke();
                    }
                });
                
                // Draw vocal particles
                this.drawVocalParticles();
            }
            
            drawVocalParticles() {
                if (!this.frequencyData) return;
                
                const vocalRange = this.vocalBands.vocal;
                let vocalIntensity = 0;
                
                for (let i = vocalRange.min; i < vocalRange.max && i < this.frequencyData.length; i++) {
                    vocalIntensity += this.frequencyData[i];
                }
                vocalIntensity /= (vocalRange.max - vocalRange.min);
                
                // Create new particles based on vocal intensity
                if (vocalIntensity > 100 && this.particles.length < 200) {
                    for (let i = 0; i < 3; i++) {
                        this.particles.push({
                            x: this.mouseX,
                            y: this.mouseY,
                            vx: (Math.random() - 0.5) * 10,
                            vy: (Math.random() - 0.5) * 10,
                            size: Math.random() * 5 + 2,
                            color: `hsl(${Math.random() * 60 + 280}, 70%, 60%)`,
                            life: 1,
                            maxLife: 100,
                            isVocal: true
                        });
                    }
                }
                
                // Update and draw particles
                this.particles = this.particles.filter(particle => {
                    particle.x += particle.vx;
                    particle.y += particle.vy;
                    particle.life--;
                    
                    if (particle.isVocal) {
                        particle.vy += 0.2; // Gravity
                        particle.vx *= 0.98; // Friction
                    }
                    
                    if (particle.life > 0) {
                        this.mainCtx.globalAlpha = particle.life / particle.maxLife;
                        this.mainCtx.fillStyle = particle.color;
                        this.mainCtx.beginPath();
                        this.mainCtx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                        this.mainCtx.fill();
                        return true;
                    }
                    return false;
                });
            }
            
            drawSynthesizer() {
                const width = this.mainCanvas.width;
                const height = this.mainCanvas.height;
                const time = Date.now() * 0.001;
                
                // Draw synthesizer grid
                const gridSize = 50;
                this.mainCtx.strokeStyle = 'rgba(102, 126, 234, 0.2)';
                this.mainCtx.lineWidth = 1;
                
                for (let x = 0; x < width; x += gridSize) {
                    this.mainCtx.beginPath();
                    this.mainCtx.moveTo(x, 0);
                    this.mainCtx.lineTo(x, height);
                    this.mainCtx.stroke();
                }
                
                for (let y = 0; y < height; y += gridSize) {
                    this.mainCtx.beginPath();
                    this.mainCtx.moveTo(0, y);
                    this.mainCtx.lineTo(width, y);
                    this.mainCtx.stroke();
                }
                
                // Draw waveform based on active notes
                if (Object.keys(this.synthOscillators).length > 0) {
                    this.mainCtx.beginPath();
                    this.mainCtx.strokeStyle = '#667eea';
                    this.mainCtx.lineWidth = 3;
                    
                    for (let x = 0; x < width; x++) {
                        let y = height / 2;
                        
                        Object.keys(this.synthOscillators).forEach(note => {
                            const frequency = this.synthOscillators[note].frequency.value;
                            y += Math.sin((x / width) * Math.PI * 4 + time * frequency * 0.01) * 50;
                        });
                        
                        if (x === 0) {
                            this.mainCtx.moveTo(x, y);
                        } else {
                            this.mainCtx.lineTo(x, y);
                        }
                    }
                    
                    this.mainCtx.stroke();
                }
                
                // Draw frequency spectrum
                if (this.frequencyData) {
                    const barWidth = width / this.bufferLength * 4;
                    let x = 0;
                    
                    for (let i = 0; i < this.bufferLength; i += 4) {
                        const barHeight = (this.frequencyData[i] / 255) * height * 0.5;
                        
                        const hue = (i / this.bufferLength) * 360;
                        this.mainCtx.fillStyle = `hsl(${hue}, 70%, 50%)`;
                        this.mainCtx.fillRect(x, height - barHeight, barWidth - 2, barHeight);
                        
                        x += barWidth;
                    }
                }
                
                // Draw particles
                this.drawParticles();
            }
            
            drawQuantum() {
                const width = this.mainCanvas.width;
                const height = this.mainCanvas.height;
                const time = Date.now() * 0.001;
                
                // Draw quantum field
                const gridSize = 30;
                const field = [];
                
                for (let x = 0; x < width; x += gridSize) {
                    for (let y = 0; y < height; y += gridSize) {
                        const audioInfluence = this.frequencyData ? 
                            this.frequencyData[Math.floor((x / width) * this.bufferLength)] / 255 : 0;
                        
                        const distance = Math.sqrt(
                            Math.pow(x - this.mouseX, 2) + 
                            Math.pow(y - this.mouseY, 2)
                        );
                        
                        const wave = Math.sin(distance * 0.01 - time * 2) * audioInfluence;
                        const size = gridSize * 0.8 * (1 + wave * 0.5);
                        
                        const hue = (distance * 0.5 + time * 50) % 360;
                        this.mainCtx.fillStyle = `hsl(${hue}, 70%, ${50 + wave * 20}%)`;
                        
                        this.mainCtx.save();
                        this.mainCtx.translate(x + gridSize / 2, y + gridSize / 2);
                        this.mainCtx.rotate(wave * Math.PI);
                        this.mainCtx.fillRect(-size / 2, -size / 2, size, size);
                        this.mainCtx.restore();
                    }
                }
                
                // Draw quantum connections
                this.mainCtx.strokeStyle = 'rgba(102, 126, 234, 0.3)';
                this.mainCtx.lineWidth = 1;
                
                for (let i = 0; i < 20; i++) {
                    const x1 = Math.random() * width;
                    const y1 = Math.random() * height;
                    const x2 = this.mouseX + (Math.random() - 0.5) * 200;
                    const y2 = this.mouseY + (Math.random() - 0.5) * 200;
                    
                    this.mainCtx.beginPath();
                    this.mainCtx.moveTo(x1, y1);
                    this.mainCtx.lineTo(x2, y2);
                    this.mainCtx.stroke();
                }
                
                // Draw quantum particles
                this.drawQuantumParticles();
            }
            
            drawQuantumParticles() {
                const particleCount = 50;
                
                for (let i = 0; i < particleCount; i++) {
                    const angle = (i / particleCount) * Math.PI * 2 + Date.now() * 0.001;
                    const radius = 100 + Math.sin(Date.now() * 0.001 + i) * 50;
                    
                    const x = this.mouseX + Math.cos(angle) * radius;
                    const y = this.mouseY + Math.sin(angle) * radius;
                    
                    const audioInfluence = this.frequencyData ? 
                        this.frequencyData[i * 10] / 255 : 0;
                    
                    const size = 3 + audioInfluence * 5;
                    
                    this.mainCtx.fillStyle = `hsl(${i * 7}, 70%, 60%)`;
                    this.mainCtx.beginPath();
                    this.mainCtx.arc(x, y, size, 0, Math.PI * 2);
                    this.mainCtx.fill();
                }
            }
            
            drawNeural() {
                const time = Date.now() * 0.001;
                
                // Update neuron activations based on audio
                if (this.frequencyData) {
                    this.neurons.forEach((neuron, i) => {
                        const audioIndex = Math.floor((i / this.neurons.length) * this.frequencyData.length);
                        neuron.targetActivation = this.frequencyData[audioIndex] / 255;
                        neuron.activation += (neuron.targetActivation - neuron.activation) * 0.1;
                    });
                }
                
                // Draw connections
                this.neurons.forEach((neuron, i) => {
                    neuron.connections.forEach(connectionIndex => {
                        const other = this.neurons[connectionIndex];
                        const strength = neuron.activation * other.activation;
                        
                        this.mainCtx.strokeStyle = `rgba(102, 126, 234, ${strength})`;
                        this.mainCtx.lineWidth = strength * 3;
                        this.mainCtx.beginPath();
                        this.mainCtx.moveTo(neuron.x, neuron.y);
                        this.mainCtx.lineTo(other.x, other.y);
                        this.mainCtx.stroke();
                    });
                });
                
                // Draw neurons
                this.neurons.forEach(neuron => {
                    const size = 5 + neuron.activation * 15;
                    
                    // Neuron glow
                    const gradient = this.mainCtx.createRadialGradient(
                        neuron.x, neuron.y, 0,
                        neuron.x, neuron.y, size * 2
                    );
                    gradient.addColorStop(0, `rgba(102, 126, 234, ${neuron.activation})`);
                    gradient.addColorStop(1, 'rgba(102, 126, 234, 0)');
                    
                    this.mainCtx.fillStyle = gradient;
                    this.mainCtx.beginPath();
                    this.mainCtx.arc(neuron.x, neuron.y, size * 2, 0, Math.PI * 2);
                    this.mainCtx.fill();
                    
                    // Neuron core
                    this.mainCtx.fillStyle = `hsl(${240 + neuron.activation * 60}, 70%, ${50 + neuron.activation * 30}%)`;
                    this.mainCtx.beginPath();
                    this.mainCtx.arc(neuron.x, neuron.y, size, 0, Math.PI * 2);
                    this.mainCtx.fill();
                });
                
                // Draw signals
                this.drawNeuralSignals(time);
            }
            
            drawNeuralSignals(time) {
                const signalCount = 10;
                
                for (let i = 0; i < signalCount; i++) {
                    const progress = ((time * 0.5 + i / signalCount) % 1);
                    const neuronIndex = Math.floor(progress * this.neurons.length);
                    const neuron = this.neurons[neuronIndex];
                    
                    if (neuron.connections.length > 0) {
                        const targetIndex = neuron.connections[Math.floor(Math.random() * neuron.connections.length)];
                        const target = this.neurons[targetIndex];
                        
                        const x = neuron.x + (target.x - neuron.x) * (progress * 10 % 1);
                        const y = neuron.y + (target.y - neuron.y) * (progress * 10 % 1);
                        
                        this.mainCtx.fillStyle = `hsla(${280 + i * 10}, 100%, 70%, ${1 - progress})`;
                        this.mainCtx.beginPath();
                        this.mainCtx.arc(x, y, 3, 0, Math.PI * 2);
                        this.mainCtx.fill();
                    }
                }
            }
            
            drawParticles() {
                this.particles.forEach(particle => {
                    // Update particle
                    particle.x += particle.vx;
                    particle.y += particle.vy;
                    
                    // Bounce off edges
                    if (particle.x < 0 || particle.x > this.mainCanvas.width) particle.vx *= -1;
                    if (particle.y < 0 || particle.y > this.mainCanvas.height) particle.vy *= -1;
                    
                    // Audio influence
                    if (this.frequencyData) {
                        const audioIndex = Math.floor(particle.frequency);
                        const audioInfluence = this.frequencyData[audioIndex] / 255;
                        particle.size = 1 + audioInfluence * 5 * this.settings.intensity;
                    }
                    
                    // Mouse attraction
                    const dx = this.mouseX - particle.x;
                    const dy = this.mouseY - particle.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < 200) {
                        particle.vx += dx * 0.0001;
                        particle.vy += dy * 0.0001;
                    }
                    
                    // Draw particle
                    this.mainCtx.fillStyle = particle.color;
                    this.mainCtx.globalAlpha = 0.8;
                    this.mainCtx.beginPath();
                    this.mainCtx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                    this.mainCtx.fill();
                });
                
                this.mainCtx.globalAlpha = 1;
            }
            
            updateFrequencyBars() {
                if (!this.frequencyData) return;
                
                const bars = document.querySelectorAll('.freq-bar');
                bars.forEach((bar, index) => {
                    const dataIndex = Math.floor((index / bars.length) * this.frequencyData.length);
                    const value = this.frequencyData[dataIndex] / 255;
                    bar.style.height = `${value * 100}%`;
                });
            }
        }
        
        // Initialize the visualizer
        window.addEventListener('DOMContentLoaded', () => {
            new ImmersiveAudioVisualizer();
        });
    </script>
</body>
</html>